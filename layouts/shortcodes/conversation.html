{{- /*
Claude Code-style terminal conversation shortcode
Usage:
{{< conversation >}}
user: Your message here
assistant: Assistant response
tool: Bash(command here)
output: Tool output here
{{< /conversation >}}
*/ -}}

<div class="terminal" data-height-adjust="{{ .Get "height-adjust" | default "0" }}">
  <button class="term-restart" title="Restart animation">â†»</button>
  <div class="term-messages"></div>
  <div class="term-line term-input">
    <span class="term-prefix">&gt;</span>
    <span class="term-content"></span>
  </div>
  <script type="application/json" class="term-data">
{{- $lines := split .Inner "\n" -}}
{{- $messages := slice -}}
{{- $currentMessage := dict -}}
{{- range $lines -}}
  {{- $line := trim . " \t\r" -}}
  {{- if $line -}}
    {{- if hasPrefix $line "user:" -}}
      {{- if $currentMessage.type -}}
        {{- $messages = $messages | append $currentMessage -}}
      {{- end -}}
      {{- $currentMessage = dict "type" "user" "content" (trim (substr $line 5) " ") -}}
    {{- else if hasPrefix $line "assistant:" -}}
      {{- if $currentMessage.type -}}
        {{- $messages = $messages | append $currentMessage -}}
      {{- end -}}
      {{- $assistantText := trim (substr $line 10) " " -}}
      {{- $assistantText = replace $assistantText "You're absolutely right!" "<a href=\"https://absolutelyright.lol/\" target=\"_blank\" rel=\"noopener\" class=\"term-text\">You're absolutely right!</a>" -}}
      {{- $currentMessage = dict "type" "assistant" "content" $assistantText -}}
    {{- else if hasPrefix $line "tool:" -}}
      {{- if $currentMessage.type -}}
        {{- $messages = $messages | append $currentMessage -}}
      {{- end -}}
      {{- $toolContent := trim (substr $line 5) " " -}}
      {{- $failed := false -}}
      {{- if strings.Contains $toolContent " fail=true" -}}
        {{- $failed = true -}}
        {{- $toolContent = replaceRE " fail=true$" "" $toolContent -}}
      {{- end -}}
      {{- $currentMessage = dict "type" "tool" "content" $toolContent "failed" $failed -}}
    {{- else if hasPrefix $line "output:" -}}
      {{- if $currentMessage.type -}}
        {{- $messages = $messages | append $currentMessage -}}
      {{- end -}}
      {{- $currentMessage = dict "type" "output" "content" (trim (substr $line 7) " ") -}}
    {{- else if hasPrefix $line "error:" -}}
      {{- if $currentMessage.type -}}
        {{- $messages = $messages | append $currentMessage -}}
      {{- end -}}
      {{- $currentMessage = dict "type" "error" "content" (trim (substr $line 6) " ") -}}
    {{- else if hasPrefix $line "interrupted" -}}
      {{- if $currentMessage.type -}}
        {{- $messages = $messages | append $currentMessage -}}
      {{- end -}}
      {{- $name := "Claude" -}}
      {{- $rest := trim (substr $line 11) " " -}}
      {{- if $rest -}}
        {{- $name = $rest -}}
      {{- end -}}
      {{- $currentMessage = dict "type" "interrupted" "content" "" "name" $name -}}
    {{- else if hasPrefix $line "processing:" -}}
      {{- if $currentMessage.type -}}
        {{- $messages = $messages | append $currentMessage -}}
      {{- end -}}
      {{- $currentMessage = dict "type" "processing" "content" (trim (substr $line 11) " ") -}}
    {{- else if eq $line "processing" -}}
      {{- if $currentMessage.type -}}
        {{- $messages = $messages | append $currentMessage -}}
      {{- end -}}
      {{- $currentMessage = dict "type" "processing" "content" "" -}}
    {{- else -}}
      {{- /* Line doesn't start with a known prefix - append to current message */ -}}
      {{- if $currentMessage.type -}}
        {{- $currentContent := $currentMessage.content -}}
        {{- if $currentContent -}}
          {{- $currentMessage = merge $currentMessage (dict "content" (printf "%s\n%s" $currentContent $line)) -}}
        {{- else -}}
          {{- $currentMessage = merge $currentMessage (dict "content" $line) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- /* Append the last message */ -}}
{{- if $currentMessage.type -}}
  {{- $messages = $messages | append $currentMessage -}}
{{- end -}}
{{ $messages | jsonify | safeJS }}
</script>
</div>